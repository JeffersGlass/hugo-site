<!DOCTYPE html>
<html lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Improving Website Experience with AWS Cloudfront Stats</title>
	<meta name="description" content="Electronics, Making, Software Development, and Amateur Radio from a Midwest Nerd">
	
	
	
	
	<link rel ="stylesheet" type="text/css" href="../../css/style.css">
	
	<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Improving Website Experience with AWS Cloudfront Stats"/>
<meta name="twitter:description" content="I was digging around in the available statistics for this very site on my Cloudfront Distribution, when I came across an interesting chart."/>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.1/css/lightbox.min.css" />	
	<script src='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.js'></script>
	<link href='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css' rel='stylesheet' />

	
<script async src="https://www.googletagmanager.com/gtag/js?id=G-BZTF8S6M1E"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-BZTF8S6M1E', { 'anonymize_ip': false });
}
</script>


	<link rel="icon" href="../../favicon.ico?v=2"> 
	
</head>
<body>
	
	<main>
		<header>

<div class="fixed z-20 flex flex-row items-end w-full p-2 bg-green-800 t-0">
    
    <div class="flex-none hidden lg:flex">
        <div class="flex-none px-2">
            <span class="px-4 text-3xl font-bold text-green-200 transition duration-500 transform hover:text-green-50">
                <a href='../../' class= "no-style-link">Jeff Glass</a>
            </span>
        </div>
        <div class="flex-none menu-item-green ">
            <a href="../../#Introduction" class="z-30 clickable-link-box no-style-link"><span></span></a>
            Home
        </div>
        <div class="flex-none menu-item-green">
            <a href="../../project" class="z-30 clickable-link-box no-style-link"><span></span></a>
            Projects
        </div>
        <div class="flex-none menu-item-green">
            <a href="../../post" class="z-30 clickable-link-box no-style-link"><span></span></a> Blog  
        </div>
        <div class="flex-none menu-item-green">
            <a href="../../oneoff" class="z-30 clickable-link-box no-style-link"><span></span></a>
            One-Offs
        </div>
        <div class="flex-none menu-item-green">
            <a href="../../resume" class="z-30 clickable-link-box no-style-link"><span></span></a>
            Resume
        </div>
    </div>
    
    <div class="flex justify-start flex-1 w-auto lg:hidden align-left large-menu">
        <div class="flex-none menu-item-green mobile-menu-button">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
        </div>
        <div class="flex-none">
            <span class="px-4 text-3xl font-bold text-green-200 transition duration-500 transform hover:text-green-50">
                <a href='../../' class= "no-style-link">Jeff Glass</a>
            </span>
        </div>
    </div>
    
    
    <div class="hidden text-green-200 transition mobile-menu">
            <div class="w-auto m-auto"><a href="../../"         class="block w-auto px-2 py-2 m-auto text-2xl transition duration-300 no-style-link hover:bg-green-500">Home</a></div>
            <div class="w-auto m-auto"><a href="../../project"  class="block w-auto px-2 py-2 m-auto text-2xl transition duration-300 no-style-link hover:bg-green-500">Projects</a></div>
            <div class="w-auto m-auto"><a href="../../post"     class="block w-auto px-2 py-2 m-auto text-2xl transition duration-300 no-style-link hover:bg-green-500">Blog</a></div>
            <div class="w-auto m-auto"><a href="../../oneoff"   class="block w-auto px-2 py-2 m-auto text-2xl transition duration-300 no-style-link hover:bg-green-500">One-Offs</a></div>
            <div class="w-auto m-auto"><a href="../../resume"   class="block w-auto px-2 py-2 m-auto text-2xl transition duration-300 no-style-link hover:bg-green-500">Resume</a></div>
    </div>
    
    <div class="justify-end flex-1 hidden w-auto h-auto align-top md:flex social-buttons">
        <div class="flex-none menu-item-green social-buttons">
            <a href="https://www.youtube.com/channel/UCjgmTMVx2B5_DOB3bCZBq7A" class="z-30 clickable-link-box no-style-link" target="_blank"><span></span></a>
            <svg class = "z-0" width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M5 7H19C19.5523 7 20 7.44771 20 8V16C20 16.5523 19.5523 17 19 17H5C4.44772 17 4 16.5523 4 16V8C4 7.44772 4.44772 7 5 7ZM2 8C2 6.34315 3.34315 5 5 5H19C20.6569 5 22 6.34315 22 8V16C22 17.6569 20.6569 19 19 19H5C3.34315 19 2 17.6569 2 16V8ZM10 9L14 12L10 15V9Z" fill="currentColor"/>
            </svg>
        </div>
        <div class="flex-none menu-item-green social-buttons">
            <a href="https://www.twitter.com/jeffersglass" class="z-30 clickable-link-box no-style-link" target="_blank"><span></span></a>
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" class="ionicon" viewBox="0 0 512 512"><path d="M496 109.5a201.8 201.8 0 01-56.55 15.3 97.51 97.51 0 0043.33-53.6 197.74 197.74 0 01-62.56 23.5A99.14 99.14 0 00348.31 64c-54.42 0-98.46 43.4-98.46 96.9a93.21 93.21 0 002.54 22.1 280.7 280.7 0 01-203-101.3A95.69 95.69 0 0036 130.4c0 33.6 17.53 63.3 44 80.7A97.5 97.5 0 0135.22 199v1.2c0 47 34 86.1 79 95a100.76 100.76 0 01-25.94 3.4 94.38 94.38 0 01-18.51-1.8c12.51 38.5 48.92 66.5 92.05 67.3A199.59 199.59 0 0139.5 405.6a203 203 0 01-23.5-1.4A278.68 278.68 0 00166.74 448c181.36 0 280.44-147.7 280.44-275.8 0-4.2-.11-8.4-.31-12.5A198.48 198.48 0 00496 109.5z" fill="currentColor"/></svg>
        </div>
        <div class="flex-none menu-item-green social-buttons">
            <a href="https://www.linkedin.com/in/jeffrey-r-glass" class="z-30 clickable-link-box no-style-link" target="_blank"><span></span></a>
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 512 512"><path d="M444.17,32H70.28C49.85,32,32,46.7,32,66.89V441.61C32,461.91,49.85,480,70.28,480H444.06C464.6,480,480,461.79,480,441.61V66.89C480.12,46.7,464.6,32,444.17,32ZM170.87,405.43H106.69V205.88h64.18ZM141,175.54h-.46c-20.54,0-33.84-15.29-33.84-34.43,0-19.49,13.65-34.42,34.65-34.42s33.85,14.82,34.31,34.42C175.65,160.25,162.35,175.54,141,175.54ZM405.43,405.43H341.25V296.32c0-26.14-9.34-44-32.56-44-17.74,0-28.24,12-32.91,23.69-1.75,4.2-2.22,9.92-2.22,15.76V405.43H209.38V205.88h64.18v27.77c9.34-13.3,23.93-32.44,57.88-32.44,42.13,0,74,27.77,74,87.64Z" fill="currentColor"/></svg>
        </div>
    </div>
</div>
</header>
<script>
    const btn = document.querySelector("div.mobile-menu-button")
    const mobileMenu = document.querySelector(".mobile-menu")
    const largeMenu = document.querySelector(".large-menu")
    const socialButtons = document.querySelector(".social-buttons")

    btn.addEventListener("click", () =>{
        openMenu();
    })

    function openMenu() {
        mobileMenu.classList.toggle("hidden");
        largeMenu.classList.toggle("hidden");
        socialButtons.classList.add("hidden");
    }

    
    const smSize = 640;
    const mdSize = 768;
    const largeSize = 1024;
    window.addEventListener('resize', function(event) {
        if (event.target.screen.width > smSize ){
            mobileMenu.classList.add("hidden");
            largeMenu.classList.remove("hidden");
        }
    }, true);
</script>

		<div class="w-full bg-green-800 bg-opacity-10">
			<div class="pt-16"></div>
			<article class="w-full px-16 pt-4 pb-4 m-auto lg:w-11/12 bg-gray-50">
				<h1 class="pb-2 text-4xl">Improving Website Experience with AWS Cloudfront Stats</h1>
				
				<div>
					<span>Tags:</span>
					
					<a href="../../tags/cloud-resume">Cloud-Resume</a>
					
				</div>
				
				<hr>
				<div>
					<p class="post-p">I was digging around in the available statistics for this very site on <a href="post/Cloud-Resume-Challenge-Cloudfront-for-HTTPs">my Cloudfront Distribution</a>, when I came across an interesting chart.</p>
<img src="dailyhits.PNG" alt="A chart showing the total requests per day for this website. The hits range from roughly one thousand to over 2500" class="post-img lg:w-2/5">
<p class="post-p">Wow, almost 2500 hits to my Cloudfront cache on 3/8! My site must be getting so much traffic!</p>
<p class="post-p">Or is it? Let's dig futher into the cache stats and see what's happening. The next charge on this page shows percentage of viewer requests by result type and... it doesn't look good. Especially if I stretch it out cover the last month.</p>
<img src="hitsmisses2.PNG" alt="A chart showing the percentage of hits, misses, and errors for users (hosts) requesting pages from this site. Before March 2 they are mostly misses, but on March 2 the errors shoot up wildly." class="post-img">
<p class="post-p">Well, double dang. Two things that jump out immediately:</p>
<ul class="post-ul">
    <li>Before about March 2nd, roughly 60% of the requests to the site were generating misses. That's fine, just means that content wasn't being accessed all that often. But:</li>
    <li>After about March 2nd, roughly 50% of the requests to the site were generating errors.</li>
</ul>
<p class="post-p">That March 2nd date makes some sense - that's when I officially switched over all (most) of my content from my old wordpress site to this hugo-made site. I finalized this while <a href="../../project/usitt2022">sitting in a convention hall in Baltimore</a>, so I guess it's not 100% surprising that something was left unaccounted for. And I know that there are a couple pieces of content that I haven't ported over at time of writing (specially, links to the Electronics Bash class pages.) But let's see if we can determine exactly what's failing.</p>
<p class="post-p">The 'Popular Objects' view gives a pretty straightforward view of what users (or scrapers) are looking for. Anything that has only 4xx responses (and/or zero cache hits) is likely to be something that doesn't exist on our site. And if necessary, we can compare this list to the view of the past month (before and after changeover-day) to see what resources are no longer being found.</p>
<div class="flex"><img src="popularmisses1.PNG" alt="A chart of the most popularly acessed objects on my site in the last 7 days. The most common hits and misses are mentioned in the text." class="post-img lg:w-2/5"><img src="popularmisses2.PNG" alt="A chart of the most popularly acessed objects on my site in the last 7 days. The most common hits and misses are mentioned in the text." class="post-img lg:w-2/5"></div>
<p class="post-p">Wow, almost 2000 requests for <code class="code">/feed</code> in the last week that have gone nowhere. This makes sense - it's a default URL for RSS feeds in a wordpress site. It doesn't look like that's something I broke specifically at my Wordpress transition, but it'd be nice to allow scrapers looking for wordpress sites to actually find my feed, I think. Since the default RSS feed in a Hugo build are at <code class="code">/index.xml</code>, I'd like to <a href="../../post/cloud-resume-challenge-aliases/">add a redirect</a> to make that happen. Unfortunately, it seems like <a href="https://discourse.gohugo.io/t/rss-url-or-an-alias/35501/2">redirects/aliases in Hugo can only create aliases with an html extention</a>, so I'll need to go about this another way.</p>
<hr>
<p class="post-p">I was a little worried that I'd hit a dead-end at this point. After all, I'm hosting this static site through S3 specifically to eliminate the need for a webserver, but I assumed I'd need an actual server to create proper 301 redirects. Thankfully, it seems <a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/how-to-page-redirect.html">S3 has basic redirect capabilities built in</a> after all. (<span class="italic"><span class="font-bold">Update:</span> on later examination this method has some issues - skip to the next Update tag for the new method.</span>)</p>
<p>There are options for redirect rules (up to 50), which can handle redirecting by prefix, postfix, error code, etc, though only 50 rules are allowed per site. Individual objects can also be setup to redirect to other objects, which seems like perhaps what we want in this case.</p>
<p class="post-p">I'll start by createing a file at <code class="code">/static/feed</code> (no suffix), which will appear on my site at <code class="code">https://jeff.glass/feed</code>, the address I want to redirect. I'll <a href="post/cloud-resume-challenge-hugo/">build my site</a> and <a href="post/cloud-resume-challenge-github-for-frontend/">push it to the GitHub Repo that stores the site's code</a>, where a GitHub action automatically pushes it to my S3 bucket within a couple mintues.</p>
<p class="post-p">Once the new feed object appears in the S3 bucket, we can pretty easily <a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/how-to-page-redirect.html#redirect-requests-object-metadata">follow the steps outlined here</a> to create a redirect. We simply edit the objects metadata, add a key of type <code class="code">x-amx-website-redirect-location</code> with a value of the new URL we wish to point to. <span class="italic">That key is available in a dropdown, no need to type it.</span></p>
<img src="redirectfeed.PNG" alt="The metadata field of an object in a S3 bucket, showing the redirect key and value described in the text" class="post-img">
<p class="post-p">Now if you go to <a href="https://jeff.glass/feed">https://jeff.glass/feed</a>, you (or an RSS reader) will be redirected to <code class="code">/index.xml</code> where the actual RSS feed lives. Pretty slick!</p>
<p class="post-p">One thing I tested at this point is whether the object will retain its metadata even if the underlying object is changed. I tweaked the text of the <code class="code">/feed</code> object some, rebuilt the site and reuploaded it, and unfortunately the answer is <span class="font-bold">no</span>. However, because the <a href="https://awscli.amazonaws.com/v2/documentation/api/latest/reference/s3/sync.html">AWS CLI Sync Action</a> which is used under the hood by <a href="https://github.com/jakejarvis/s3-sync-action">Jake Jarvis' Github to S3 Sync Action</a> only overwrites new files, so long as we don't modify the static <code class="code">/feed</code> object, that metadata should remain indefinitely.</p>
<p class="post-p"><span class="font-bold">Update:</span> It seems that some of what I determined about the persistance of the object metadata is not true, and that the metadata is getting wiped whenever I rebuild and re-upload the site. Which is a shame, this would have been a nice clean way to handle this case. Thankfully, we can still use the site Redirection Rules in the Static Site settings of our S3 bucket to redirect from /feed to /index.xml as follows. The three seperate rules are required to make sure we can handle requests for both <code class="code">/feed</code> and <code class="code">/feed/</code> requests, the latter being the location of my feed under the old Wordpress site.</p>
<pre class="w-auto px-4 mx-4 mb-4 bg-gray-200">
    [
    {
        "Condition": {
            "KeyPrefixEquals": "feed/"
        },
        "Redirect": {
            "HostName": "index.xml",
            "HttpRedirectCode": "301"
        }
    },
    {
        "Condition": {
            "KeyPrefixEquals": "feed"
        },
        "Redirect": {
            "ReplaceKeyPrefixWith": "index.xml"
        }
    },
    {
        "Condition": {
            "KeyPrefixEquals": "index.xml/"
        },
        "Redirect": {
            "ReplaceKeyPrefixWith": "index.xml"
        }
    }
]
</pre>
<hr>
<p class="post-p">The resource with the next-most 4xx responses is for <code class="code">robots.txt</code>. This is a page that tells crawlers that obey the <a href="https://en.wikipedia.org/wiki/Robots_exclusion_standard">Robots Exclusion Standard</a> what they are and aren't allowed to crawl on your site. We can <a href="https://gohugo.io/templates/robots/">generate it in Hugo very simply</a> by adding <code class="code">enableRobotsTXT = true</code> to our <code class="code">config.toml</code> file. We could also add a <code class="code">robots.txt</code> file to our templates folder to override the default Hugo template (which allows everything to be crawled), but I think the default is fine in my case.</p>
<p class="post-p"><code class="code">xmlrpc.php</code> is apparently a <a href="https://www.hostinger.com/tutorials/xmlrpc-wordpress">long-outdated way of accessing Wordpress sites remotely</a>. I don't know if it has any legitimate uses anymore, but since my site is in no way Wordpress-ed, I don't need it.</p>
<p class="post-p">That said, perhaps it would be nice if the site showed something more testful than server-garbge when an inaccessible page was requested.</p>
<img src="whatishere.PNG" alt="A server error message reading '404 Not Found" class="post-img">
<p class="post-p">Hugo has capablities to help us with this too. By adding a <code class="code">layouts/404.html</code> page, we can <a href="https://gohugo.io/templates/404/">customize what's shown to the end user</a> when they request a page that can't be found. There are some opinions online, however, that <a href="https://moonbooth.com/hugo/custom-404/">maybe this isn't the best thing to do.</a> But I'm not going to bite off more than I can chew at this point.</p>
<p class="post-p">To give my 404 page a little more life and interest, I'll have it include cards for 5 pages on the site. While I initially thought these should be random, like the oneoffs on the index page, I think perhaps its better that they represent the best content on the site in a curated way. I can somewhat reuse the "card" layout I built for the index page for this.</p>
<img src="nice404.PNG" alt="A screenshot of the 404 page of the website showing 5 content cards: cloud resume challenge, Demilight, Setting Up and Electronics Lab, Advent of Code, and Soft Shutdown and Consistent Boot on Power Loss" class="post-img">
<p class="post-p">I did have to learn a bit more about Hugos range and slice capabilities so I could store the selected pages in an array, rather than inserting them all individually into the template. The final syntax is:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">{{ <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">pages</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">slice</span> <span style="color:#e6db74">&#34;/project/demilight&#34;</span> <span style="color:#e6db74">&#34;post/setting-up-an-electronics-lab-tools/&#34;</span> <span style="color:#e6db74">&#34;post/advent-of-code-2021/&#34;</span> <span style="color:#e6db74">&#34;post/quick-dirty-system-power/&#34;</span> }}
{{ <span style="color:#66d9ef">range</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">pages</span> }}
    {{ <span style="color:#a6e22e">with</span> <span style="color:#960050;background-color:#1e0010">$</span>.<span style="color:#a6e22e">GetPage</span> . }}
        {{ .<span style="color:#a6e22e">Render</span> <span style="color:#e6db74">&#34;card&#34;</span> }}
    {{ <span style="color:#a6e22e">end</span> }}
{{ <span style="color:#a6e22e">end</span> }}  
</code></pre></td></tr></table>
</div>
</div>
<p class="post-p">Because the Cloud Resume Challenge page is actually a list page, I inserted it manually with some HTML.</p>
<p class="post-p">Finally, there's a small amount of configuration to be done in the S3 bucket to clarify that <code class="code">404.html</code> is indeed the error page.</p>
<hr>
<p class="post-p">So, that takes care of the assorted wordpress holdovers I no longer need. The only remaining items that are giving 404-responses are a number of links to images of various sizes, all to <code class="code">/wp-content/uploads/</code>. At first I was worried that this was someone hotlinking to these images from outside my domain, but a quick search of my site proved me wrong.</p>
<p class="post-p">When I <a href="http://localhost:1313/post/cloud-resume-challenge-porting-wordpress-blogs-to-hugo/">ported this blog to Hugo using Python</a>, I missed the fact that, in many posts created on wordpress, images are embedded as thumbnails which link to larger versions of the original image. I failed to remove or update those links, so the images on my site were still linking to the (now dead) wordpress images. Thankfully, a quick regex find-and-replace (<code class="code">&lt;a href=\&quot;.+wp-content/uploads/.+&gt;(.+)&lt;/a&gt;</code> replaced with <code class="code">$1</code>) cleared up almost all of these instances. One more with irregular formatting was swatted by hand.</p>
<img src="changeview.PNG" alt="A screenshot of VS Code showing the find-and-replace interface for multiple replacement. Lines to be added are color-coded green, those being deleted are color-coded red." class="post-img">
<hr>
<p class="post-p">And with that, hopefully I've nipped all those pesky 404 responses in bud. I know there are some remaining pages I have left to port over from Wordpress, but since they aren't seeing many hits on Cloudflare, I'm not feeling terribly urgent about them. Besides, the new 404 page makes the response to missing content much cleaner.</p>
				</div>
				
			</article>
			<footer>
    <div class = "pt-4 pb-6 text-center text-gray-500" id="Footer">
        <p class="">All contents © Jeff Glass 2022. All rights reserved.</p>
        <p>See <a href="../../cloud-resume-challenge" class="underline">how this site was built</a>.</p>
    </div>
</footer>
		</div>
	</main>


	<script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.1/js/lightbox.min.js"></script>
	<script>
		lightbox.option({
			'fadeDuration': 200,
			'resizeDuration': 200
		})
	</script>
</body>
</html>
