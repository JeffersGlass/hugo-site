---
title: "File I/O in Pyscript Files"
date: 2022-08-09T19:16:21-05:00
draft: true
tags:
- python
- pyscript
description: "How to use modules that generate and open binary files within Pyscript"
---
<py-env>
    - matplotlib
    - fpdf2
    - Pillow
</py-env>
<script defer src="https://pyscript.net/latest/pyscript.js"></script>
<link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
<p class="post-p">Say you have some Python code running in Pyscript that outputs a file of an arbitrary type. How can you make that file accessible to browser in the way that other files are? E.g. how can we generate a plot image with matplotlib and use it as the <code class="code">src</code> of an <code class="code">&lt;img&gt;</code> tag? Or how can we generate a pdf with a library like <a href="https://pyfpdf.github.io/fpdf2/index.html">fpdf2</a> and make it available to download? </p>
<p class="italic post-p">For more details on working with the browser's virtual file system, see <a href="https://www.jhanley.com/pyscript-files-and-file-systems-part-1/">John Hanley's extensive writeup</a>.</p>
<div class="w-1/2 h-24 mx-auto bg-red-200">
    <p class="">Inspiring image of pdfs and images in browser here? Gif?</p>
</div>
<p class="post-p">Let's take three useful Python modules - matplotlib, Pillow, and fpdf2 - and see how we can use their outputs in the browser. We'll start from the point where we've saved their contents to the virtual filesystem, just as if we were running a local python program.</p>
{{< showandrun file="content\post\pyscript-files\savefiles.py" direction="flip" >}}
<p class="post-p">If we want to double check that the files really are saved, we can take a look at the virtual filesystem using the <code class="code">os</code> module:</p>
{{< showandrun file="content\post\pyscript-files\checkonfiles.py" direction="flip" >}}
<p class="post-p">There are many strategies from this point; we'll work from the most generic (reading/writing raw bytes) to more specialized options for images and plots.</p>
<h3 class="post-h3">Generic Files</h2>
<p class="post-p">We'll start with the pdf, which we'd like for the user to be able to download, and which for today's purposes is just a big bundle of bytes. We'll need to wrap up this object into some kind of form that Javascript knows how to work with.</p>
<p class="post-p">That form is the <a href="https://developer.mozilla.org/en-US/docs/Web/API/File">File interface</a>, a special kind of <a href="https://developer.mozilla.org/en-US/docs/Web/API/Blob">Blob</a> on data that represents a file object. The File constructor takes an Iterable containing ArrayBuffers, TypeArrays, and other iterable Javascript objects as its data, as well as name and an optional dictionary of options.</p>
<p class="post-p">So, we'll need to pass the File constructor the data from our file, a new name for it, and the appropraite <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types">MIME Type</a> for our file. For some reason, while pyodide is typically amazing about <a href="https://pyodide.org/en/stable/usage/type-conversions.html#type-translations-pyproxy-to-js">automatically proxying objects from Python to Javascript</a> this is one situation where we'll need to manually proxy our data using <a href="https://pyodide.org/en/stable/usage/api/python-api/ffi.html#pyodide.ffi.to_js">to_js</a>:</p>
{{< showandrun file="content\post\pyscript-files\loadpdf.py" direction="flip" >}}
<p class="post-p">From here, we can do anything <a href="https://developer.mozilla.org/en-US/docs/Web/API/File_API/Using_files_from_web_applications">Javascript knows how to do</a> with a File object, but for today's purposes, let's look at how to download a file we've created.</p>
<h4 class="post-h4">Downloading Files</h4>
<p class="post-p">In HTML, you can make a link download a file by setting only a couple attributes. The <a href="https://www.w3schools.com/tags/att_a_download.asp">download attribute</a> tells the browser the file is to be downloaded, with the filename set as the value of this attribute. The file itself is specified with the <a href="https://www.w3schools.com/tags/att_a_href.asp">href attribute</a> like any link. But that means we'd need a URL for the PDF file, which at the moment only exists in memory. Thankfully, the browser's <a href="https://developer.mozilla.org/en-US/docs/Web/API/URL/createObjectURL">createObjectURL</a> function solves our problem: it creates a URL for File (or Blob) objects.</p>
{{< showandrun file="content\post\pyscript-files\downloadpdf.py" direction="flip" >}}
<p class="post-p">Notice that we haven't actually added this link to the page yet - it exists nowhere, unclickable by human hands.</p>
<p class="post-p">But just because humans can't click it, doesn't mean Pyscript can't. Let's set up a py-button to do just that:</p>
<div class="">
    <p class="code-title">index.html <span class="italic">(partial)</span></p>
    {{< highlight html >}}
<py-button label="Download PDF">
    def on_click(event):
        hidden_link.click()
</py-button>{{< /highlight >}}
</div>
<div class="flex flex-col items-center justify-center m-4">
    <py-button class="" label="Download PDF">
        def on_click(event):
            hidden_link.click()
    </py-button>
    <span class="text-xs italic">Clicking will download a ~1kb PDF</span>
</div>
<p class="post-p">Of course, there's no reason the py-button has to solely click our hidden link. It could do other things. If we're generating contents of our PDF dynamically, we might want all of our previous logic to be executing only when the user clicks the "download" button. Separating the onscreen object triggering the action (the py-button, though it could be a link or other browser action) from the hidden link is very helpful here. It allows us to take whatever actions we wish to prepare the file, and only then to download it.</p>

<h3 class="post-h3">Images</h3>
<h3 class="post-h3">Matplotlib</h3>

<!-- <p class="post-p">Thankfully, Python already has a way of create file-like objects in memory: the <a href="https://docs.python.org/3/library/io.html#io.BytesIO">io.BytesIO object</a>. Via inheritance from ,<a href="https://docs.python.org/3/library/io.html#io.IOBase">IOBase</a> and <a href="https://docs.python.org/3/library/io.html#io.BufferedIOBase">BuffersIOBase</a>, it implements all the operations we associate with file handles: <code>open()</code>, <code>close()</code>, <code>read()</code>, <code>readline()</code>, <code>write()</code>, etc. We can use it almost anywhere we can use a file, and lots of modules explicitly remind us of options like this. Take the start of the documention for matplotlib's <code class="code">pyplot.savefig()</code> </p> -->