---
title: "Cloud Resume Challenge - Dockerfiles"
date: 2021-11-29T12:36:07-05:00
draft: true
static_slug: /img/cloudresumeslug.png
tags:
- Cloud Resume Challenge
---
<p class="post-paragraph">I'm setting out to rectify a pretty silly part of my workflow. Namely, when I want to push new content to the site that I've built with hugo, I:</p>
<ol class="post-ol">
    <li>Clean my current hugo build locally (removing /public, /resources/ and /dist). Slightly unnecessary, but has cleared some issues in the past.</li>
    <li>Rebuild all files using <code>npx hugo</code></li>
    <li>Add all files to git using <code>git add -A</code></li>
    <li>Commit the new files using <code>git commit -m "Commit Message Here"</code></li>
</ol>
<p class="post-paragraph">This pushes the new files to github, which triggers a github action to upload the files in the ./public folder to s3.</p>
<p class="post-paragraph">There must be a better way.</p>
<p class="post-paragraph">And I'm confident there is - I'd love to use some like <a href="https://github.com/JeffersGlass/hugo-build-action">Jake Jarvis' Hugo Build Action</a> to automatically rebuild the site whenever new code is pushed to Github or merged into the main branch. The issue is, the Docker image that Jarvis has used doesn't happen to include tailwind as part of its build. So, I think the way forward is for me to learn enough about docker and dockerfiles to add Tailwind to a fork of Jarvis' action, and use that to build my site.</p>
<p class="post-paragraph">The dockerfile for this action is remarkably short:{{< highlight docker >}}
# https://github.com/jakejarvis/hugo-docker
FROM ghcr.io/jakejarvis/hugo-extended:0.89.4

ENTRYPOINT ["hugo"]{{< /highlight >}}</p>
<p class="post-paragraph">From what I understand, this is using a pre-built docker image stored online (via Github?) to improve the speed of this action. That seems like quite a deep rabbit hole to go down, though an interesting one, but let's see if there's a faster way.</p>
<p class="post-paragraph">One thing that occurs to me is to see if anyone else has forked this repo, to make their own changes in the way I'm interesed in. And indeed, I'm the 10th person to fork this action, and several of them are X commits <span class="italic">ahead</span> of the original (as well as being several behind), meaning they've made some tweaks and changes. Let's look at <a href="https://github.com/willbicks/hugo-build-action/commit/96b801e40324dc378775d648a2d202ea244837ce">one of these commits from willbicks</a></p>
{{< highlight ruby "linenos=false,hl_lines=4-5">}}
ruby \
${HUGO_EXTENDED:+libc6-compat libstdc++} && \
update-ca-certificates && \
+ npm install --global postcss-cli autoprefixer @babel/core @babel/cli && \
- npm install --global postcss postcss-cli autoprefixer @babel/core @babel/cli && \
pip3 install --upgrade Pygments==2.* && \
gem install asciidoctor && \
wget https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_${HUGO_EXTENDED:+extended_}${HUGO_VERSION}_Linux-64bit.tar.gz && \
{{< /highlight >}}
<p class="post-paragraph">Hang on, that's alredy way longer than the Dockerfile in my fork! But it also looks like something I could actually modify...ah, it looks like back in <a href="https://github.com/JeffersGlass/hugo-build-action/commit/0aeee3828f8f0d61ab36cfc57f8a30190c70a57b">commit #0aeee38</a>, Jarvis switched from using a fully-written-out dockerfile to a version which is hosted as one of these prebuilt images. Let's see if we can put that old, fully-written-out docker file into use with the most recent version of hugo.</p>
<p class="post-paragraph">I'll start by copy-pasting the last longhand version of the Dockerfile that Jarvis wrote. Then I'll update the Hugo version to 0.89.4 (the latest at time of writing), and add "tailwindcss" to the npm command the Dockerfile runs. Finally, I'll change the action.yml file to point to the local Dockerfile, instead of the prebuilt image. Finally, I'll commit all the changes to git and push them back upstream to Github.</p>
<p class="post-paragraph">I'll create a new workflow for this instead of blowing away my old one (that just manually published a folder to s3), called hugoBuildAndUpload.yml. I'll also disable the previous action on Github, so it doesn't try to run when the new action uploads. Having saved that new yaml file, I'll push it to Github and see what happens...</p>
<img src="noTailwind.PNG" alt="An error message saying Docker cannot find tailwindcss">
<p class="post-paragraph">Drat, not quite. Hugo seems to be running, but it still can't find tailwind, even though it should be installed via NPM now... perhaps my install order is wrong? By adding <code>require('tailwindcss/nesting')</code> to my postcss requirements and re-pushing, I can see that Hugo/postcss are indeed attempting to build the site, but aren't able to find the required tailwind dependencies. This time the error is: <code>Error: Error building site: POSTCSS: failed to transform "css/style.css" (text/css): Error: Cannot find module 'tailwindcss/nesting'</code></p>
<p class="post-paragraph">Let's see if tailwind isn't installing successfully, or if postcss can't find it for some reason. I'll add a line to the Dockerfile which should just run the -help command for tailwind on the command line, and error out if it breaks:
{{< highlight docker "hl_lines=4">}}
RUN hugo version && \
hugo env && \
postcss --version && \
tailwindcss -h && \
autoprefixer --version && \
babel --version && \
pygmentize -V && \
asciidoctor --version
{{< /highlight >}}</p>
<p class="post-paragraph">And indeed, in the action's output I can see the full help info from tailwindcss. A bit verbose perhaps, but I can at least see that tailwind is being installed successfully via npm</p>
<img src="tailwind-h.PNG" alt="A console log showing TailwiindCSS's help output on Github Actions">
<p class="post-paragraph">On a whim, and after some internet cruising, I ran across <a href="https://discourse.gohugo.io/t/postcss-error-cannot-find-module-tailwindcss/34581/4">a post on the Hugo forums</a> where a user was similarly having issues with Hugo not recognizing that tailwind was installed. The user had identified that the NODE_PATH was being set to a Yarn installation folder, and that changing it to an NPM path solved the issue. While that was related to a local build, I wondered if perhaps the Dockerfile installing yarn was screwing up my pathing? Unfortunately, removing the yarn install didn't fix the issue. There were <a href="https://github.com/dirkolbrich/hugo-theme-tailwindcss-starter/issues/5">some references from a couple years ago</a> to similar services having issues with node modules</p>