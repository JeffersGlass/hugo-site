---
title: "Coincident"
date: 2023-11-13T05:51:36-06:00
draft: true
tags:
- javascript
- Web Workers
description: "Using an proxy library for synchronizing with Web Workers"
---
<p class="post-p">For many long years, each tab in a web browser (and before that, each window) was limited to a single thread to do <span class="italic">everything</span> - render the page, run JavaScript, handle CSS animations, etc. And while it's still true that each tab only gets one <span class="italic">main</span> thread, developers now have the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers">Web Worker API</a> to spin up additional "worker threads" to "do work" without locking up everything on the page.</p>
<p class="post-p">The issue? Worker Threads and the Main Thread are not created equal. The main thread gets access to <a href="https://developer.mozilla.org/en-US/docs/Web/API/Document_Object_Model">the DOM</a> (which is to say, the page itself), nor to events that would bubble up and down on the DOM. This makes handling DOM manipulation from within a Worker quite tricky - you need to develop some way to <a href="https://developer.mozilla.org/en-US/docs/Web/API/Worker/postMessage">pass messages</a> back and forth to the worker in a meaningful way. Several wrappers for this messaging process have developed over time - Google's <a href="https://github.com/GoogleChromeLabs/comlink">Comlink</a> (and by extension Pyodide's <a href="https://github.com/pyodide/synclink">Synclink</a>), BuildIO's <a href="https://github.com/BuilderIO/partytown">PartyTown</a>, <a href="https://github.com/developit/workerize">Workerize</a> and its slimmed-down form <a href="https://github.com/developit/greenlet">Greenlet</a>, <a href="https://github.com/andywer/threads.js">threads.js</a>, and so on.</p>
<p class="post-p">Today, I want to explore <a href="https://github.com/WebReflection/coincident">Coicident</a>, the proxy library that <a href="/post/whats-new-pyscript-2023-11-1">the most Recent PyScript release</a> is using for worker orchestration.</p>

<h2 class="post-h2">A Toy Problem</h2>
<p class="post-">To give ourselves a practical example to work with, let's pick a technical problem that would benefit from spinning off some work into a worker thread. Namely, let's create a page that asks the user <span class="font-semibold">how many digits of Pi they want to calculate</span>, then spins up a worker to actually calculate them, and displays a progress bar while it does so. It will look something like this:</p>
<div class="w-full p-2 m-6 bg-gray-100 border-2 border-gray-200 md:w-1/3">
    <label for="digits">Digits of Pi to Calculate?</label><br>
    <input type="text" name="digits" id="digits1" class="border-2 border-gray-500" value="100"><br><br>
    <button class="p-1 bg-gray-200 border-2 border-gray-500 rounded-md">Calculate</button><br>
    <hr>
    <p><span class="text-2xl font-semibold">π:</span> <span class="font-semibold text-green-800">3.1415926...</span></p>
    <progress id="digits1" max="100" value="35"></progress>
</div>

<p class="post-p">Since it's always nice to work to a specification, let's lay out our toy site's features:
    <ul class="py-2 pl-8 text-justify list-disc list-outside;">
        <li>The user can type in a number into the input box</li>
        <li>When the user clicks the 'Calculate' button, a web worker will be spun up to calculate the required number of digits</li>
        <li>While the calculation is running, the 'Calculate' button will read "calculating" and the button will be disabled</li>
        <li>As the calculation in running:
            <ul class="py-1 pl-8 text-justify list-disc list-outside;">
                <li>The digits of pi will appear next to the 'π' symbol, following by "..."</li>
                <li>The progress bar will update with the amount of progress made toward the desired number of digits</li>
            </ul>
        <li>When the calculation finishes:
            <ul class="py-1 pl-8 text-justify list-disc list-outside;">
                <li>the button's label will reset to read 'Calculate'</li>
                <li>the "..." after the digits of pi will be removed</li>
                <li>A pop-up alert reading "CALCULATION FINISHED" will be displayed</li>
            </ul>
        </li>
    </ul>
</p>
<p class="post-p">So, let's get building!</p>

<h3 class="post-h3">The HTML</h3>
<p class="p">Since this writeup is really about an interesting JS library and not web development, I'll just drop the HTML we'll be using in here as-is. I've omitted all the styling that the examples on this page will be using, which is left as an excercise to the reader. (Or 'view source' if you're curious.)</p>
<div class="p-2 m-4 bg-gray-300 rounded-lg">
<p class="text-sm text-gray-700">index.html</p>
{{< highlight "html" "linenostart=1" >}}
<label for="digits">Digits of Pi to Calculate?</label>
<input type="text" name="digits" id="inp-digits">
<button id="btn-calc">Calculate</button>
<p>π: <span id="output"></span></p>
<progress id="progress" max="100" value="o"></progress>
{{< /highlight >}}
</div>

<h3 class="post-h3"></h3>


<div class="p-2 m-4 bg-blue-300 rounded-lg">
<p class="text-sm text-blue-700">main.html</p>
{{< highlight "html" "linenostart=1" >}}
<script type="module">
    import coincident from 'https://unpkg.com/coincident';
    const worker = new Worker('./worker.js', {type: 'module'});
    // set a sync or async callback to return a serializable answer
    coincident(worker).input = value => prompt(value);
</script>
{{< /highlight >}}
</div>

<div class="p-2 m-4 bg-yellow-300 rounded-lg">
<p class="text-sm text-yellow-700">worker.js</p>
{{< highlight "js" "linenostart=1" >}}
import coincident from 'https://unpkg.com/coincident';

console.log('asking for an input');
// pauses in a non blocking way the worker until the answer has been received
console.log('input', coincident(self).input('what is 1 + 2 ?'));
console.log('input received');
{{< /highlight >}}
</div>

